#!/bin/bash
#SBATCH --job-name="logs/sleep_classifier"
#SBATCH --output="logs/sleep_classifier.%j.%N.out"
#SBATCH --error="logs/sleep_classifier.%j.%N.err"
#SBATCH --partition=gpux4
#SBATCH --time=24
#SBATCH --mail-user=kcchang3@illinois.edu
#SBATCH --mail-type=ALL

source /opt/miniconda3/etc/profile.d/conda.sh
PYTHON_VIRTUAL_ENVIRONMENT=/home/kcchang3/.conda/envs/stable3.9
conda activate ${PYTHON_VIRTUAL_ENVIRONMENT}

export KALDI_ROOT=/home/hertin/softwares/kaldi
export FAIRSEQ_ROOT=/home/hertin/workplace/wav2vec/fairseq
export KENLM_ROOT=/home/hertin/softwares/kenlm/build/bin
export RVAD_ROOT=/home/hertin/workplace/wav2vec/fairseq/examples/wav2vec/unsupervised/rVADfast
export APC_ROOT=$(pwd)/Autoregressive-Predictive-Coding

set -e
set -u
set -o pipefail

WORK_DIR=/home/kcchang3/workplace/LittleBeatsPrelim
cd ${WORK_DIR}

# python sleep_classifier_w2v_audio_ecg.py \
#     --train \
#     --manifest_dir ${WORK_DIR}/manifest \
#     --per_device_train_batch_size 16 \
#     --per_device_eval_batch_size 16 \
#     --num_train_epochs 2 \
#     --ckpt_path ${WORK_DIR}/manifest/w2v-audio-and-ecg\checkpoint-best \
#     --cache_path ~/.cache/huggingface/datasets \
#     --embedding_type "audio" \
#     --audio_pretrained_model /home/kcchang3/workplace/LittleBeatsPrelim/manifest/pretrained_weights/lb_lena_4300hr.pt \
#     --ecg_pretrained_model /home/kcchang3/workplace/LittleBeatsPrelim/manifest/pretrained_weights/bp_ecg_500hr.pt \
#     --limu_pretrained_model /home/kcchang3/workplace/LittleBeatsPrelim/manifest/pretrained_weights/limu/limu_v4_sep12.pt \
#     --mode "triple" \


python -m torch.distributed.launch \
    --nproc_per_node 2 sleep_classifier_w2v_audio_ecg.py \
    --train \
    --manifest_dir ${WORK_DIR}/manifest \
    --per_device_train_batch_size 16 \
    --per_device_eval_batch_size 16 \
    --num_train_epochs 2 \
    --ckpt_path ${WORK_DIR}/manifest/w2v-audio-and-ecg\checkpoint-best \
    --cache_path ~/.cache/huggingface/datasets \
    --embedding_type "audio" \
    --audio_pretrained_model /home/kcchang3/workplace/LittleBeatsPrelim/manifest/pretrained_weights/lb_lena_4300hr.pt \
    --ecg_pretrained_model /home/kcchang3/workplace/LittleBeatsPrelim/manifest/pretrained_weights/bp_ecg_500hr.pt \
    --limu_pretrained_model /home/kcchang3/workplace/LittleBeatsPrelim/manifest/pretrained_weights/limu/limu_v4_sep12.pt \
    --mode "triple" \
